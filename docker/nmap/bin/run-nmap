#!/usr/bin/env bash

report=$1
log_file=$2
target=$3
mincvss=$4
dsn_providers=$5

if [[ -z "${report}" ]]; then echo report path argument not set; exit 1; fi
if [[ -z "${log_file}" ]]; then echo log_file path argument not set; exit 1; fi
if [[ -z "${target}" ]]; then echo target path argument not set; exit 1; fi
if [[ -z "${dsn_providers}" ]]; then echo dsn_providers argument not set; exit 1; fi
if [[ -z "${mincvss}" ]]; then
    mincvss=0
fi

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/srv/app/lib
cd /tmp
start_time="$(date -u +%s)"

nmap \
    -A \
    --privileged \
    -sV \
    --script vulners,smb-os-discovery,banner,broadcast-igmp-discovery,broadcast-listener,ssl-ccs-injection,http-comments-displayer,http-malware-host,http-referer-checker,http-traceroute,http-xssed,dns-blacklist,firewalk,traceroute-geolocation,whois-ip \
    --script-args mincvss=$mincvss \
    -v \
    -oX ${report} \
    --dns-servers ${dsn_providers} \
    ${target} >${log_file} 2>&1

end_time="$(date -u +%s)"
elapsed="$(($end_time-$start_time))"
echo "Total of $elapsed seconds elapsed for process"
exit 0
